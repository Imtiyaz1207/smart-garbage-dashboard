<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Garbage Bin Dashboard</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --accent: #16a085;
      --accent-2: #2ecc71;
      --card-bg: rgba(255,255,255,0.85);
      --glass-border: rgba(255,255,255,0.6);
      --danger: #e74c3c;
      --muted: #6b7280;
      --max-width: 1100px;
    }
    html,body{height:100%; margin:0; font-family: "Poppins", "Segoe UI", sans-serif; color:#0f1724;}
    body{
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      display:flex; justify-content:center; padding:32px 16px;
    }
    .container{
      width:100%; max-width:var(--max-width);
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:24px;
      align-items:start;
    }
    header {
      grid-column: 1 / -1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    h1{ margin:0; font-size:34px; color:#12343b; letter-spacing:-0.5px; }
    .sub { color:var(--muted); font-size:14px; }

    /* Left column cards */
    .left {
      display:flex; flex-direction:column; gap:18px;
    }
    .card {
      background: var(--card-bg);
      border-radius:16px;
      padding:20px;
      box-shadow: 0 8px 24px rgba(16,24,40,0.06);
      border:1px solid var(--glass-border);
      text-align:center;
    }
    .card h3 { margin:0 0 8px; font-size:18px; color:#12343b; }
    .value { font-size:28px; color:var(--accent); font-weight:600; margin-top:8px; }
    .value.small { font-size:16px; color:var(--muted); font-weight:500; }

    .alert {
      display:none;
      background: linear-gradient(90deg, rgba(255,230,230,0.95), rgba(255,200,200,0.95));
      border-left:6px solid var(--danger);
      color:#86181d;
      font-weight:600;
      border-radius:12px;
      padding:12px 14px;
      box-shadow:0 6px 18px rgba(231,76,60,0.08);
    }

    /* Right column (charts and controls) */
    .right {
      display:flex; flex-direction:column; gap:18px;
    }
    .chart-card {
      background: var(--card-bg);
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(16,24,40,0.06);
      border:1px solid var(--glass-border);
    }
    .chart-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:6px;}
    .chart-title { font-weight:700; color:#12343b; }
    canvas { width:100% !important; height:320px !important; }

    .controls {
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn {
      display:inline-block; padding:8px 12px; border-radius:10px; background:var(--accent-2); color:white; text-decoration:none;
      font-weight:600; box-shadow:0 6px 18px rgba(46,204,113,0.12);
    }
    .muted-info { color:var(--muted); font-size:13px; }

    footer { grid-column:1 / -1; text-align:center; color:var(--muted); font-size:13px; margin-top:8px; }

    /* responsive */
    @media (max-width:960px){
      .container{ grid-template-columns:1fr; }
      header{ flex-direction:column; align-items:flex-start; gap:10px; }
      canvas{ height:260px !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1><i class="fa-solid fa-trash-can" style="color:var(--accent); margin-right:10px;"></i> Smart Garbage Bin Dashboard</h1>
        <div class="sub">Real-time monitoring • ThingSpeak • ESP32</div>
      </div>
      <div style="text-align:right;">
        <div id="lastUpdated" class="muted-info">Last update: --</div>
        <div id="countdown" class="muted-info">Next update in 15s</div>
      </div>
    </header>

    <!-- Left column: status cards -->
    <div class="left">
      <div class="card">
        <h3><i class="fa-solid fa-chart-simple" style="margin-right:8px; color:var(--accent)"></i> Bin Full (%)</h3>
        <div id="binFullPercent" class="value">--%</div>
        <div id="avgFillSmall" class="value small">Avg (recent): --%</div>
      </div>

      <div class="card">
        <h3><i class="fa-solid fa-radar" style="margin-right:8px; color:var(--accent)"></i> IR Sensor Status</h3>
        <div id="irStatus" class="value">--</div>
        <div id="entryCount" class="value small">Entries: --</div>
      </div>

      <div class="card">
        <h3><i class="fa-solid fa-flag" style="margin-right:8px; color:var(--accent)"></i> Bin Full Flag</h3>
        <div id="binFullFlag" class="value">--</div>
        <div id="lastSMS" class="value small">Alerts sent: 0</div>
      </div>

      <div class="alert" id="alertBanner">⚠️ <span id="alertText">Bin is FULL — please empty it.</span></div>

      <div class="card" style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:700;">Controls</div>
          <div class="muted-info">Auto refresh: 15s</div>
        </div>
        <div class="controls">
          <a id="downloadCSV" class="btn" href="#" target="_blank"><i class="fa-solid fa-download"></i> Download CSV</a>
          <button id="forceRefresh" class="btn" style="background:#0ea5a4">⟳ Refresh Now</button>
          <label style="font-size:13px; color:var(--muted); margin-left:auto;">Full threshold:
            <input id="fullThreshold" type="number" value="75" min="10" max="100" style="width:64px; margin-left:8px; padding:6px; border-radius:6px; border:1px solid #e6eef0;" /> %
          </label>
        </div>
      </div>

    </div>

    <!-- Right column: charts -->
    <div class="right">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Historical Bin Full (%) — recent</div>
          <div class="muted-info">Line shows recent fill% — red dots mark FULL flag</div>
        </div>
        <canvas id="recentChart"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Weekly Average Fill (%) — last 7 days</div>
          <div class="muted-info">Daily averages (local timezone)</div>
        </div>
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>

    <footer>Built with ❤️ SHAIK IMTIYAZ & TEAM • Data from ThingSpeak</footer>
  </div>

  <script>
    // ============== CONFIG ==============
    const channelID = "3118087";   // <-- KEEP or replace
    const readAPIKey = "TB9LC5PX9MB4RWJK"; // <-- KEEP or replace
    const RESULTS_RECENT = 50;     // how many recent points to fetch
    const REFRESH_INTERVAL = 15000; // ms
    const CSV_URL = `https://api.thingspeak.com/channels/${channelID}/feeds.csv?api_key=${readAPIKey}`;

    // DOM
    const binFullPercentEl = document.getElementById('binFullPercent');
    const irStatusEl = document.getElementById('irStatus');
    const binFullFlagEl = document.getElementById('binFullFlag');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const countdownEl = document.getElementById('countdown');
    const avgFillSmallEl = document.getElementById('avgFillSmall');
    const entryCountEl = document.getElementById('entryCount');
    const alertBanner = document.getElementById('alertBanner');
    const alertText = document.getElementById('alertText');
    const downloadCSV = document.getElementById('downloadCSV');
    const lastSMSEl = document.getElementById('lastSMS');
    const forceRefreshBtn = document.getElementById('forceRefresh');
    const fullThresholdInput = document.getElementById('fullThreshold');

    downloadCSV.href = CSV_URL;

    // charts setup
    const recentCtx = document.getElementById('recentChart').getContext('2d');
    const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');

    const recentChart = new Chart(recentCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Bin Full %',
            data: [],
            borderColor: 'rgba(22,160,133,0.95)',
            backgroundColor: 'rgba(22,160,133,0.12)',
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6,
            yAxisID: 'y'
          },
          {
            label: 'Full Flag',
            data: [],
            type: 'scatter',
            backgroundColor: 'rgba(231,76,60,0.95)',
            pointRadius: 6,
            showLine: false,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive:true,
        interaction:{mode:'index', intersect:false},
        scales:{
          x:{ display:true, title:{display:false} },
          y:{ beginAtZero:true, max:100, title:{display:true, text:'Fill (%)'} }
        },
        plugins: { legend: { display:true } }
      }
    });

    const weeklyChart = new Chart(weeklyCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label:'Avg Fill %', data: [], backgroundColor:'rgba(46,204,113,0.8)' }] },
      options: {
        responsive:true,
        scales:{ y:{ beginAtZero:true, max:100, title:{display:true, text:'Avg Fill (%)'} } },
        plugins:{ legend:{ display:false } }
      }
    });

    // helper: parse ISO date and convert to local Date
    function parseISOToLocal(iso) {
      // new Date(iso) produces Date in local timezone for modern browsers if iso includes timezone
      return new Date(iso);
    }

    // helper: format HH:MM or date label
    function formatShort(dt) {
      return dt.toLocaleString([], { hour:'2-digit', minute:'2-digit' });
    }

    // === fetch & update ===
    let countdown = Math.round(REFRESH_INTERVAL/1000);
    let alertsSent = 0;

    async function fetchFeeds(results = RESULTS_RECENT) {
      const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=${results}`;
      const resp = await fetch(url, {cache:'no-store'});
      if (!resp.ok) throw new Error('Network response not ok');
      return resp.json();
    }

    function computeWeeklyAverages(feeds) {
      // build map of last 7 days (local)
      const dayMap = new Map();
      const today = new Date(); today.setHours(0,0,0,0);
      for (let i=6;i>=0;i--){
        const d = new Date(today); d.setDate(today.getDate() - i);
        dayMap.set(d.toDateString(), { date: d, sum:0, count:0 });
      }

      feeds.forEach(f => {
        if (!f.created_at) return;
        const dt = parseISOToLocal(f.created_at);
        const key = dt.toDateString();
        if (dayMap.has(key)) {
          const val = parseFloat(f.field4);
          if (!isNaN(val)) { const rec = dayMap.get(key); rec.sum += val; rec.count += 1; }
        }
      });

      const labels = [], values = [];
      dayMap.forEach((v, k) => {
        labels.push(v.date.toLocaleDateString());
        values.push(v.count ? +(v.sum / v.count).toFixed(1) : 0);
      });
      return { labels, values };
    }

    async function updateDashboard() {
      try {
        const data = await fetchFeeds(RESULTS_RECENT);
        const feeds = data.feeds || [];
        if (feeds.length === 0) {
          binFullPercentEl.textContent = "No data";
          return;
        }

        // recent last entry
        const last = feeds[feeds.length - 1];
        const lastFill = parseFloat(last.field4) || 0;
        const lastIR = parseInt(last.field2);
        const lastFlag = parseInt(last.field3);

        // summary numbers
        const values = feeds.map(f => parseFloat(f.field4) || 0);
        const avgRecent = values.reduce((a,b)=>a+b,0) / (values.length || 1);
        const entries = feeds.length;

        binFullPercentEl.textContent = `${lastFill.toFixed(1)}%`;
        avgFillSmallEl.textContent = `Avg (recent): ${avgRecent.toFixed(1)}%`;
        irStatusEl.textContent = (lastIR === 0 ? "Object Detected" : "No Object");
        entryCountEl.textContent = `Entries: ${entries}`;
        binFullFlagEl.textContent = (lastFlag === 1 ? "FULL" : "EMPTY");
        binFullFlagEl.style.color = lastFlag === 1 ? 'var(--danger)' : 'var(--accent)';

        lastUpdatedEl.textContent = 'Last update: ' + new Date(last.created_at).toLocaleString();

        // update recent chart
        const labels = feeds.map(f => formatShort(parseISOToLocal(f.created_at)));
        const datasetValues = feeds.map(f => +(parseFloat(f.field4) || 0).toFixed(1));
        const flagPoints = feeds.map((f, idx) => {
          const fl = parseInt(f.field3) || 0;
          return fl === 1 ? { x: labels[idx], y: datasetValues[idx] } : null;
        }).filter(x => x);

        recentChart.data.labels = labels;
        recentChart.data.datasets[0].data = datasetValues;
        recentChart.data.datasets[1].data = flagPoints;
        recentChart.update();

        // weekly aggregation (last 7 days)
        const weekly = computeWeeklyAverages(feeds.length ? feeds : []);
        weeklyChart.data.labels = weekly.labels;
        weeklyChart.data.datasets[0].data = weekly.values;
        weeklyChart.update();

        // alerts
        const threshold = parseFloat(fullThresholdInput.value) || 75;
        if (lastFill >= threshold) {
          alertBanner.style.display = 'block';
          alertText.innerText = `⚠️ Bin is FULL — ${lastFill.toFixed(1)}% (threshold ${threshold}%)`;
        } else {
          alertBanner.style.display = 'none';
        }

        // simple SMS alert count UI placeholder (updated from ThingSpeak if you store counters)
        lastSMSEl.textContent = `Alerts sent: ${alertsSent}`;

        // reset countdown
        countdown = Math.round(REFRESH_INTERVAL/1000);

      } catch (err) {
        console.error('Update failed:', err);
        lastUpdatedEl.textContent = 'Last update: (error)';
      }
    }

    // timer & intervals
    updateDashboard();
    let refreshTimer = setInterval(() => { updateDashboard(); }, REFRESH_INTERVAL);

    // countdown display
    setInterval(() => {
      countdown--; if (countdown <= 0) countdown = Math.round(REFRESH_INTERVAL/1000);
      countdownEl.textContent = `Next update in ${countdown}s`;
    }, 1000);

    // force refresh button
    forceRefreshBtn.addEventListener('click', () => {
      updateDashboard();
      countdown = Math.round(REFRESH_INTERVAL/1000);
    });

    // optionally update CSV link if you want custom range
    // downloadCSV.href = CSV_URL + '&start=2025-09-01%2000:00:00&end=2025-09-30%2023:59:59';

    // If you'd like to persist alerts sent count across sessions you could read a "sms_count" field from ThingSpeak and display it here.
  </script>
</body>
</html>
